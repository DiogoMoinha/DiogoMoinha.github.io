<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sistema Solar AR</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.2/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://unpkg.com/aframe-gps-camera/dist/aframe-gps-camera.min.js"></script>
    <script src="https://unpkg.com/aframe-gps-entity-place/dist/aframe-gps-entity-place.min.js"></script>
    <script src="./js/dynamic-movement.js"></script>
    <script src="./js/show-plane.js"></script>
    <script src="./js/compute-offset.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden">
    <a-scene
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true;"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      window.onload = () => {
        const scene = document.querySelector("a-scene");

        const planets = [
          { name: "Mercury", color: "#a9a9a9", radius: 0.15, distance: 8, speed: 0.1, description: "Pequeno e rochoso" },
          { name: "Venus",   color: "#f5deb3", radius: 0.22, distance: 12, speed: 0.08, description: "Atmosfera densa" },
          { name: "Earth",   color: "#0000ff", radius: 0.25, distance: 16, speed: 0.07, description: "O nosso lar azul" },
          { name: "Mars",    color: "#ff4500", radius: 0.2,  distance: 20, speed: 0.06, description: "Planeta vermelho" },
          { name: "Jupiter", color: "#d2b48c", radius: 0.5,  distance: 28, speed: 0.04, description: "Gigante gasoso" },
          { name: "Saturn",  color: "#daa520", radius: 0.45, distance: 34, speed: 0.03, description: "Com anéis visíveis" },
          { name: "Uranus",  color: "#00ffff", radius: 0.35, distance: 40, speed: 0.025, description: "Inclinação extrema" },
          { name: "Neptune", color: "#00008b", radius: 0.35, distance: 46, speed: 0.02, description: "O mais distante" }
        ];

        // Espera até o GPS estar pronto
        document.querySelector("[gps-camera]").addEventListener("gps-camera-update-position", (e) => {
          const userLat = e.detail.position.latitude;
          const userLon = e.detail.position.longitude;

          planets.forEach((planet) => {
            const coords = computeOffset(userLat, userLon, planet.distance, 0);

            const sphere = document.createElement("a-sphere");
            sphere.setAttribute("gps-new-entity-place", { latitude: coords.lat, longitude: coords.lon });
            sphere.setAttribute("radius", planet.radius);
            sphere.setAttribute("color", planet.color);
            sphere.setAttribute("shadow", "");
            sphere.setAttribute("show-plane", {
              color: "black",
              name: planet.name,
              description: planet.description
            });

            if (planet.speed > 0) {
              sphere.setAttribute("dynamic-movement", {
                type: "spin",
                speed: planet.speed,
                originLat: userLat,
                originLon: userLon,
                distance: planet.distance
              });

              createCylinderOrbit(userLat, userLon, planet.distance);
            }

            scene.appendChild(sphere);
          });
        });

        function createCylinderOrbit(originLat, originLon, radius) {
          const segments = 48; // Mais = órbita mais suave

          for (let i = 0; i < segments; i++) {
            const angle = (360 / segments) * i;
            const nextAngle = (360 / segments) * (i + 1);

            const start = computeOffset(originLat, originLon, radius, angle);
            const end = computeOffset(originLat, originLon, radius, nextAngle);

            const cylinder = document.createElement("a-cylinder");
            cylinder.setAttribute("gps-new-entity-place", `latitude: ${start.lat}; longitude: ${start.lon}`);
            cylinder.setAttribute("radius", 0.05);
            cylinder.setAttribute("height", 1);
            cylinder.setAttribute("color", "white");
            cylinder.setAttribute("material", "opacity: 0.4; transparent: true");

            const rotation = getRotationBetweenPoints(start, end);
            cylinder.setAttribute("rotation", `${rotation.x} ${rotation.y} ${rotation.z}`);

            scene.appendChild(cylinder);
          }
        }

        function getRotationBetweenPoints(start, end) {
          const dx = end.lon - start.lon;
          const dz = end.lat - start.lat;
          const angleY = Math.atan2(dx, dz) * (180 / Math.PI);
          return { x: 90, y: angleY, z: 0 };
        }
      };
    </script>
  </body>
</html>
