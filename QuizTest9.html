// =======================
// Variáveis globais
// =======================
let originLat = null;
let originLon = null;
let completedPlanets = [];
let score = 0;

// =======================
// Funções de progresso e pontuação
// =======================
function markPlanetAsCompleted(planetName) {
  if (!completedPlanets.includes(planetName)) {
    completedPlanets.push(planetName);
    localStorage.setItem("completedPlanets", JSON.stringify(completedPlanets));
  }
}

function updateScoreDisplay() {
  document.getElementById("score-display").innerText = `Pontuação: ${score}`;
}

function showCompletionMark(planetEl) {
  const check = document.createElement("a-text");
  check.setAttribute("value", "✅");
  check.setAttribute("align", "center");
  check.setAttribute("position", `0 ${planetEl.getAttribute("radius") + 0.5} 0`);
  check.setAttribute("scale", "2 2 2");
  planetEl.appendChild(check);
}

// =======================
// Reset do jogo no arranque
// =======================
function resetGameOnStart() {
  localStorage.removeItem("score");
  localStorage.removeItem("completedPlanets");
  completedPlanets = [];
  score = 0;
  updateScoreDisplay();
}
resetGameOnStart();

// =======================
// Inicialização da origem
// =======================
navigator.geolocation.getCurrentPosition(
  (pos) => {
    originLat = pos.coords.latitude;
    originLon = pos.coords.longitude;

    // Carregar progresso guardado
    completedPlanets = JSON.parse(localStorage.getItem("completedPlanets") || "[]");

    // Criar sistema solar
    createPlanets(originLat, originLon);
  },
  (err) => console.error("Erro GPS:", err),
  { enableHighAccuracy: true }
);

// =======================
// Criar planetas
// =======================
function createPlanets(baseLat, baseLon) {
  const scene = document.querySelector("a-scene");

  planetsData.forEach((planet) => {
    const sphere = document.createElement("a-sphere");
    sphere.setAttribute("name", planet.name);
    sphere.setAttribute("radius", planet.radius);
    sphere.setAttribute("color", planet.color);

    // Posição com base na origem fixa
    sphere.setAttribute("gps-entity-place", {
      latitude: baseLat + planet.offsetLat,
      longitude: baseLon + planet.offsetLon
    });

    // Adicionar quiz se planeta não concluído
    if (!completedPlanets.includes(planet.name)) {
      sphere.setAttribute("proximity-check", {
        questions: JSON.stringify(planet.questions)
      });
    } else {
      showCompletionMark(sphere);
    }

    scene.appendChild(sphere);
  });
}

// =======================
// Componente para verificar proximidade
// =======================
AFRAME.registerComponent("proximity-check", {
  schema: { questions: { type: "string" } },

  init: function () {
    this.questions = JSON.parse(this.data.questions);
    this.currentQuestionIndex = 0;
    this.triggeredOnce = false;

    // Se planeta já concluído, bloqueia quiz
    if (completedPlanets.includes(this.el.getAttribute("name"))) {
      this.triggeredOnce = true;
    }
  },

  tick: function () {
    if (this.triggeredOnce) return;

    const player = document.querySelector("[gps-camera]");
    const distance = this.el.object3D.position.distanceTo(player.object3D.position);

    if (distance < 5) { // distância de ativação
      this.triggeredOnce = true;
      this.showQuestion();
    }
  },

  showQuestion: function () {
    const questionData = this.questions[this.currentQuestionIndex];
    const modal = document.getElementById("quiz-modal");
    const questionText = document.getElementById("quiz-question");
    const answersDiv = document.getElementById("quiz-answers");

    questionText.innerText = questionData.question;
    answersDiv.innerHTML = "";

    questionData.answers.forEach((ans, i) => {
      const btn = document.createElement("button");
      btn.innerText = ans;

      btn.onclick = () => {
        if (i === questionData.rightAnswer) {
          btn.classList.add("correct");
          score += 10;
          updateScoreDisplay();
          this.currentQuestionIndex++;

          if (this.currentQuestionIndex >= this.questions.length) {
            markPlanetAsCompleted(this.el.getAttribute("name"));
            showCompletionMark(this.el);
          } else {
            this.triggeredOnce = false;
          }
        } else {
          btn.classList.add("wrong");
          score -= 5;
          updateScoreDisplay();
        }

        setTimeout(() => {
          modal.classList.remove("show");
        }, 1000);
      };

      answersDiv.appendChild(btn);
    });

    modal.classList.add("show");
  }
});
