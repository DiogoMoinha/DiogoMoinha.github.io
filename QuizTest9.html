<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AR.js A-Frame Solar Quiz</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>
  <script>
// =======================
// Variáveis globais
// =======================
let originLat = null;
let originLon = null;
let completedPlanets = [];
let score = 0;

// =======================
// Funções de progresso e pontuação
// =======================
function markPlanetAsCompleted(planetName) {
  if (!completedPlanets.includes(planetName)) {
    completedPlanets.push(planetName);
    localStorage.setItem("completedPlanets", JSON.stringify(completedPlanets));
  }
}

function updateScoreDisplay() {
  document.getElementById("score-display").innerText = `Pontuação: ${score}`;
}

function showCompletionMark(planetEl) {
  const check = document.createElement("a-text");
  check.setAttribute("value", "✅");
  check.setAttribute("align", "center");
  check.setAttribute("position", `0 ${planetEl.getAttribute("radius") + 0.5} 0`);
  check.setAttribute("scale", "2 2 2");
  planetEl.appendChild(check);
}

// =======================
// Reset do jogo no arranque
// =======================
function resetGameOnStart() {
  localStorage.removeItem("score");
  localStorage.removeItem("completedPlanets");
  completedPlanets = [];
  score = 0;
  updateScoreDisplay();
}
resetGameOnStart();

// =======================
// Inicialização da origem
// =======================
navigator.geolocation.getCurrentPosition(
  (pos) => {
    originLat = pos.coords.latitude;
    originLon = pos.coords.longitude;

    // Carregar progresso guardado
    completedPlanets = JSON.parse(localStorage.getItem("completedPlanets") || "[]");

    // Criar sistema solar
    createPlanets(originLat, originLon);
  },
  (err) => console.error("Erro GPS:", err),
  { enableHighAccuracy: true }
);

// =======================
// Criar planetas
// =======================
function createPlanets(baseLat, baseLon) {
  const scene = document.querySelector("a-scene");

  planetsData.forEach((planet) => {
    const sphere = document.createElement("a-sphere");
    sphere.setAttribute("name", planet.name);
    sphere.setAttribute("radius", planet.radius);
    sphere.setAttribute("color", planet.color);

    // Posição com base na origem fixa
    sphere.setAttribute("gps-entity-place", {
      latitude: baseLat + planet.offsetLat,
      longitude: baseLon + planet.offsetLon
    });

    // Adicionar quiz se planeta não concluído
    if (!completedPlanets.includes(planet.name)) {
      sphere.setAttribute("proximity-check", {
        questions: JSON.stringify(planet.questions)
      });
    } else {
      showCompletionMark(sphere);
    }

    scene.appendChild(sphere);
  });
}

// =======================
// Componente para verificar proximidade
// =======================
AFRAME.registerComponent("proximity-check", {
  schema: { questions: { type: "string" } },

  init: function () {
    this.questions = JSON.parse(this.data.questions);
    this.currentQuestionIndex = 0;
    this.triggeredOnce = false;

    // Se planeta já concluído, bloqueia quiz
    if (completedPlanets.includes(this.el.getAttribute("name"))) {
      this.triggeredOnce = true;
    }
  },

  tick: function () {
    if (this.triggeredOnce) return;

    const player = document.querySelector("[gps-camera]");
    const distance = this.el.object3D.position.distanceTo(player.object3D.position);

    if (distance < 5) { // distância de ativação
      this.triggeredOnce = true;
      this.showQuestion();
    }
  },

  showQuestion: function () {
    const questionData = this.questions[this.currentQuestionIndex];
    const modal = document.getElementById("quiz-modal");
    const questionText = document.getElementById("quiz-question");
    const answersDiv = document.getElementById("quiz-answers");

    questionText.innerText = questionData.question;
    answersDiv.innerHTML = "";

    questionData.answers.forEach((ans, i) => {
      const btn = document.createElement("button");
      btn.innerText = ans;

      btn.onclick = () => {
        if (i === questionData.rightAnswer) {
          btn.classList.add("correct");
          score += 10;
          updateScoreDisplay();
          this.currentQuestionIndex++;

          if (this.currentQuestionIndex >= this.questions.length) {
            markPlanetAsCompleted(this.el.getAttribute("name"));
            showCompletionMark(this.el);
          } else {
            this.triggeredOnce = false;
          }
        } else {
          btn.classList.add("wrong");
          score -= 5;
          updateScoreDisplay();
        }

        setTimeout(() => {
          modal.classList.remove("show");
        }, 1000);
      };

      answersDiv.appendChild(btn);
    });

    modal.classList.add("show");
  }
});


    AFRAME.registerComponent('planet-distance-tracker', {
      tick() {
        const camera = document.querySelector('[gps-new-camera]');
        const gpsComponent = camera.components['gps-new-camera'];
        if (!gpsComponent || !gpsComponent._currentPosition) return;

        const camCoords = gpsComponent._currentPosition;
        const planets = document.querySelectorAll('[gps-new-entity-place]');

        let closest = null;
        let minDistance = Infinity;

        planets.forEach((planet) => {
          const entityCoords = planet.getAttribute('gps-new-entity-place');
          if (!entityCoords) return;

          const dist = getDistanceFromLatLonInM(
            camCoords.latitude,
            camCoords.longitude,
            entityCoords.latitude,
            entityCoords.longitude
          );

          if (dist < minDistance) {
            minDistance = dist;
            closest = planet;
          }
        });

        const display = document.getElementById('distanceDisplay');
        if (closest && minDistance < 1000) {
          const name = closest.getAttribute('name') || 'um planeta';
          display.textContent = `${Math.round(minDistance)} metros até ${name}`;
        } else if (closest) {
          const name = closest.getAttribute('name') || 'um planeta';
          display.textContent = `Aproximando-se de ${name}`;
        }
      }
    });

    AFRAME.registerComponent('show-plane', {
      schema: { name: { type: 'string' }, desc: { type: 'string' }, image: { type: 'string' } },
      init() {
        this.el.addEventListener('click', () => {
          const desc = this.data.desc || "Sem descrição disponível.";
          const panel = document.getElementById('info-panel');
          const text = document.getElementById('info-text');
          text.innerHTML = `<strong>${this.data.name}</strong><br><img src="${this.data.image}" style="max-width:100%; border-radius:10px;"/><br><br>${desc}`;
          panel.style.display = 'block';
        });
      }
    });

    async function initPlanets() {
      try {
        const response = await fetch('system2.json');
        const data = await response.json();

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              originLat = position.coords.latitude;
              originLon = position.coords.longitude;
              createPlanets(originLat, originLon, data);
            },
            (error) => console.error("Erro ao obter localização:", error),
            { enableHighAccuracy: true }
          );
        } else {
          console.error("Geolocalização não suportada.");
        }
      } catch (error) {
        console.error("Erro ao carregar system2.json:", error);
      }
    }

    function createOrbitRing(userLat, userLon, orbitDistance) {
      const ring = document.createElement("a-ring");
      ring.setAttribute("gps-new-entity-place", {latitude: userLat, longitude: userLon});
      ring.setAttribute("radius-inner", orbitDistance - 1);
      ring.setAttribute("radius-outer", orbitDistance + 1);
      ring.setAttribute("rotation", "-90 0 0");
      ring.setAttribute("material", { color: "#ffffff", shader: "flat", opacity: 0.3, side: "double" });
      document.querySelector("a-scene").appendChild(ring);
    }

    function createPlanets(originLat, originLon, data) {
      const planetData = data.planets;
      const scene = document.querySelector("a-scene");

      planetData.forEach((planet) => {
        const entity = document.createElement("a-entity");
        entity.setAttribute("cursor", "rayOrigin:mouse");

        const sphere = document.createElement("a-sphere");
        sphere.setAttribute("name", planet.name);
        let coords;

        if (planet.name === "Sol") {
          coords = { lat: originLat, lon: originLon };
        } else {
          coords = computeOffset(originLat, originLon, planet.distanciafoco1, 0);
        }

        sphere.setAttribute("gps-new-entity-place", { latitude: coords.lat, longitude: coords.lon });
        sphere.setAttribute("radius", planet.size);
        sphere.setAttribute("shadow", "");
        const imgSrc = "data:image/jpg;base64," + planet.texture;
        sphere.setAttribute("material", { src: imgSrc, shader: "standard" });
        sphere.setAttribute("show-plane", { name: planet.name, desc: planet.description, image: planet.image });

        if (planet.speed > 0 && planet.name !== "Sol") {
          sphere.setAttribute("dynamic-movement", {
            type: "spin",
            speed: planet.speed,
            originLat: originLat,
            originLon: originLon,
            distance: planet.distanciafoco1
          });
          createOrbitRing(originLat, originLon, planet.distanciafoco1);
        }

        if (planet.questions && planet.questions.length > 0) {
          sphere.setAttribute("proximity-check", {
            range: 5,
            questions: JSON.stringify(planet.questions),
            triggered: false
          });
        }

        // Mostrar marca de concluído se já feito
        if (completedPlanets.includes(planet.name)) {
          showCompletionMark(sphere);
        }

        entity.appendChild(sphere);
        scene.appendChild(entity);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      score = parseInt(localStorage.getItem("solar_quiz_score")) || 0;
      initPlanets();
      updateScoreDisplay();
    });
  </script>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; }
    .quiz-modal {
      position: fixed; top: -999px; left: -999px; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
      z-index: 9999; transition: all 0.3s ease;
    }
    .quiz-modal.show { top: 0; left: 0; }
    .quiz-content { background: white; padding: 20px; width: 90%; max-width: 400px; border-radius: 12px; text-align: center; }
    .quiz-answer {
      display: block; padding: 10px; margin: 10px auto; width: 100%;
      background: #eee; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s;
    }
    .quiz-answer.correct { background-color: #4CAF50; color: white; }
    .quiz-answer.incorrect { background-color: #f44336; color: white; }
  </style>
</head>
<body>
  <div class="quiz-modal" id="quizModal">
    <div class="quiz-content">
      <h1 id="quizPlanetName"></h1>
      <h2 id="quizQuestion"></h2>
      <div id="quizAnswers"></div>
    </div>
  </div>

  <div id="info-panel" style="display: none; position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.85); color: white;
    padding: 20px; border-radius: 10px; max-width: 80%; text-align: center;
    font-family: sans-serif; z-index: 999;">
    <span id="info-text"></span><br><br>
    <button onclick="document.getElementById('info-panel').style.display='none'" style="
      background: red; color: white; border: none; padding: 10px 20px;
      cursor: pointer; border-radius: 5px; font-size: 1em;">Fechar</button>
  </div>

  <div id="distanceDisplay" style="position: fixed; bottom: 10px; left: 50%;
    transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white;
    padding: 10px 20px; border-radius: 10px; font-size: 16px;
    z-index: 9999; pointer-events: none; font-family: sans-serif;">
    Procurando planetas...
  </div>

  <div id="scoreDisplay" style="position: fixed; top: 10px; left: 50%;
    transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white;
    padding: 10px 20px; border-radius: 10px; font-size: 16px;
    z-index: 9999; pointer-events: none; font-family: sans-serif;">
    Pontuação: 0
  </div>

  <a-scene vr-mode-ui="enabled: false" arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false">
    <a-camera gps-new-camera="gpsMinDistance: 1" planet-distance-tracker></a-camera>
  </a-scene>
</body>
</html>
